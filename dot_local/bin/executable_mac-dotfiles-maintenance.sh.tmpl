#!/usr/bin/env bash

set -euo pipefail

LOG_DIR="$HOME/.local/state/mac-dotfiles"
LOG_FILE="$LOG_DIR/maintenance.log"
LOCK_DIR="$LOG_DIR/maintenance.lock"
AUTO_CHEZMOI_UPDATE="${AUTO_CHEZMOI_UPDATE:-1}"
BREW_MAINTENANCE_SCRIPT="$HOME/.local/bin/mac-dotfiles-brew-maintenance.sh"

mkdir -p "$LOG_DIR"

if ! mkdir "$LOCK_DIR" 2>/dev/null; then
    echo "‚ö†Ô∏è  Maintenance already running (lock: $LOCK_DIR), skipping"
    exit 0
fi

cleanup_lock() {
    rmdir "$LOCK_DIR" 2>/dev/null || true
}
trap cleanup_lock EXIT

exec > >(tee -a "$LOG_FILE") 2>&1

echo ""
echo "===== $(date '+%Y-%m-%d %H:%M:%S') :: mac-dotfiles maintenance ====="

if [[ "$AUTO_CHEZMOI_UPDATE" == "1" ]]; then
    if command -v chezmoi >/dev/null 2>&1; then
        echo "üß© Syncing dotfiles with chezmoi..."
        if ! chezmoi update --apply; then
            echo "‚ö†Ô∏è  chezmoi update failed. Continuing with Homebrew maintenance."
        fi
    else
        echo "‚ö†Ô∏è  chezmoi not installed, skipping dotfiles sync"
    fi
else
    echo "‚ÑπÔ∏è  AUTO_CHEZMOI_UPDATE=0, skipping dotfiles sync"
fi

if [[ ! -f "$BREW_MAINTENANCE_SCRIPT" ]]; then
    echo "‚ö†Ô∏è  Missing helper script: $BREW_MAINTENANCE_SCRIPT"
    echo "   Run chezmoi apply to install all managed scripts, then retry."
    exit 1
fi

# shellcheck source=/dev/null
source "$BREW_MAINTENANCE_SCRIPT"
run_brew_maintenance

echo "‚úÖ Maintenance completed"
