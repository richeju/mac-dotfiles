#!/usr/bin/env bash

set -euo pipefail

LOG_DIR="$HOME/.local/state/mac-dotfiles"
LOG_FILE="$LOG_DIR/maintenance.log"
LOCK_DIR="$LOG_DIR/maintenance.lock"
AUTO_CHEZMOI_UPDATE="${AUTO_CHEZMOI_UPDATE:-1}"

mkdir -p "$LOG_DIR"

if ! mkdir "$LOCK_DIR" 2>/dev/null; then
    echo "âš ï¸  Maintenance already running (lock: $LOCK_DIR), skipping"
    exit 0
fi

cleanup_lock() {
    rmdir "$LOCK_DIR" 2>/dev/null || true
}
trap cleanup_lock EXIT

exec > >(tee -a "$LOG_FILE") 2>&1

echo ""
echo "===== $(date '+%Y-%m-%d %H:%M:%S') :: mac-dotfiles maintenance ====="

if [[ "$AUTO_CHEZMOI_UPDATE" == "1" ]]; then
    if command -v chezmoi >/dev/null 2>&1; then
        echo "ðŸ§© Syncing dotfiles with chezmoi..."
        if ! chezmoi update --apply; then
            echo "âš ï¸  chezmoi update failed. Continuing with Homebrew maintenance."
        fi
    else
        echo "âš ï¸  chezmoi not installed, skipping dotfiles sync"
    fi
else
    echo "â„¹ï¸  AUTO_CHEZMOI_UPDATE=0, skipping dotfiles sync"
fi

if ! command -v brew >/dev/null 2>&1; then
    echo "âš ï¸  Homebrew not installed, skipping maintenance"
    exit 0
fi

echo "ðŸ“¦ Updating Homebrew..."
brew update

echo "â¬†ï¸  Upgrading formulae..."
brew upgrade

echo "â¬†ï¸  Upgrading casks..."
brew upgrade --cask --greedy

echo "ðŸ§¹ Cleaning up old versions..."
brew cleanup -s

echo "ðŸ” Running diagnostics..."
if ! brew doctor; then
    echo "âš ï¸  brew doctor reported issues. Review the logs."
fi

echo "ðŸ“Š Cache statistics:"
du -sh "$(brew --cache)" 2>/dev/null || echo "Cache empty"

echo "âœ… Maintenance completed"
