#!/usr/bin/env bash

set -euo pipefail

LOG_DIR="$HOME/.local/state/mac-dotfiles"
LOG_FILE="$LOG_DIR/maintenance.log"

mkdir -p "$LOG_DIR"

exec > >(tee -a "$LOG_FILE") 2>&1

echo ""
echo "===== $(date '+%Y-%m-%d %H:%M:%S') :: mac-dotfiles maintenance ====="

if ! command -v brew >/dev/null 2>&1; then
    echo "âš ï¸  Homebrew not installed, skipping maintenance"
    exit 0
fi

echo "ðŸ“¦ Updating Homebrew..."
brew update

echo "â¬†ï¸  Upgrading formulae..."
brew upgrade

echo "â¬†ï¸  Upgrading casks..."
brew upgrade --cask --greedy

echo "ðŸ§¹ Cleaning up old versions..."
brew cleanup -s

echo "ðŸ” Running diagnostics..."
if ! brew doctor; then
    echo "âš ï¸  brew doctor reported issues. Review the logs."
fi

echo "ðŸ“Š Cache statistics:"
du -sh "$(brew --cache)" 2>/dev/null || echo "Cache empty"

echo "âœ… Maintenance completed"
